<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Gerencial - Restaurante</title>
  <style>
    *{box-sizing:border-box;font-family:Arial,sans-serif}
    body{margin:0;padding:18px;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#111827;border:1px solid #334155;border-radius:14px;padding:16px;margin-bottom:14px}
    h2,h3{margin:0 0 10px 0}
    .muted{color:#94a3b8;font-size:12px;line-height:1.35}
    label{display:block;margin-top:10px;font-weight:bold;font-size:13px}
    input,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid #475569;
      background:#0b1220;color:#e5e7eb;margin-top:6px
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    button{
      background:#b91c1c;border:none;color:#fff;padding:10px 14px;border-radius:10px;
      font-weight:bold;cursor:pointer
    }
    button.secondary{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .kpis{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px 12px;min-width:180px}
    .kpi b{display:block;margin-bottom:6px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#0b1220;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #334155;padding:8px;text-align:left;font-size:13px;vertical-align:top}
    th{color:#cbd5e1}
    .ok{color:#86efac}
    .err{color:#fca5a5}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h2>Painel Gerencial</h2>
      <p class="muted">
        Painel separado do site dos clientes. Use a senha para atualizar cardápio, listar pedidos e ver dashboard.
      </p>

      <label>Senha do painel</label>
      <input id="password" type="password" placeholder="Digite a senha do estabelecimento" />

      <div class="actions">
        <button class="secondary" id="btnTestar">Testar conexão</button>
        <span id="statusTopo" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>Cardápio (atualizar)</h3>

      <label>URL da imagem do cardápio (opcional)</label>
      <input id="cardapioImg" placeholder="Ex.: https://.../cardapio.jpg" />
      <p class="muted">Você pode colar uma URL pública OU enviar a imagem do PC abaixo.</p>

      <label>Enviar imagem do PC</label>
      <input id="cardapioFile" type="file" accept="image/*" />
      <p class="muted">Ao enviar, a imagem vai para o Google Drive e a URL é atualizada automaticamente.</p>

      <div class="actions">
        <button class="secondary" id="btnEnviarImagem">Enviar imagem</button>
        <span id="statusUpload" class="muted"></span>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>Texto do cardápio (opcional)</label>
          <textarea id="cardapioTexto" placeholder="Ex.: Segunda: Feijoada..."></textarea>
        </div>
        <div>
          <label>Prévia</label>
          <div class="card" style="margin:0;padding:10px;background:#0b1220;border-color:#334155;">
            <img id="previewImg" src="" alt="Prévia do cardápio" style="width:100%;border-radius:12px;display:none;border:1px solid #334155;">
            <p id="previewHint" class="muted" style="margin:0;">Sem prévia ainda.</p>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnCarregarCardapio" class="secondary">Carregar atual</button>
        <button id="btnSalvarCardapio">Salvar (usar URL)</button>
        <span id="statusCardapio" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>Dashboard</h3>
      <div class="kpis" id="kpis"></div>
      <div class="chips" id="chipsPg"></div>
      <div class="chips" id="chipsOrigem"></div>

      <div class="actions">
        <button class="secondary" id="btnDash">Atualizar dashboard</button>
        <span id="statusDash" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>Pedidos</h3>
      <p class="muted">Lista os últimos 500 pedidos. Exporta CSV (Excel).</p>

      <div class="actions">
        <button class="secondary" id="btnPedidos">Carregar pedidos</button>
        <button class="secondary" id="btnExportar" disabled>Exportar CSV</button>
        <span id="statusPedidos" class="muted"></span>
      </div>

      <div style="overflow:auto;margin-top:12px;">
        <table id="tbl">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
  // ✅ API do Google Apps Script
  const API_URL = "https://script.google.com/macros/s/AKfycbzx3CT2Ow75Zb5JSQ8cy1toem9nFgHqxXHOK_6CbUuioZ5ar6zT1zzzyup_c02-uHs2/exec";

  const $ = (id) => document.getElementById(id);

  function setStatus(el, msg, ok=null){
    el.textContent = msg ? msg : "";
    if (ok === true) el.className = "muted ok";
    else if (ok === false) el.className = "muted err";
    else el.className = "muted";
  }

  function password(){ return $("password").value || ""; }

  async function getPublic(){
    const r = await fetch(API_URL, { cache: "no-store" });
    return r.json();
  }

  async function postAdmin(payload){
    const r = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ ...payload, password: password() }),
      headers: { "Content-Type": "text/plain;charset=utf-8" }
    });
    return r.json();
  }

  function setPreview(url){
    const img = $("previewImg");
    const hint = $("previewHint");
    if (url && url.trim()) {
      img.src = url.trim();
      img.style.display = "block";
      hint.style.display = "none";
    } else {
      img.src = "";
      img.style.display = "none";
      hint.style.display = "block";
    }
  }

  // Testar conexão
  $("btnTestar").onclick = async () => {
    try{
      setStatus($("statusTopo"), "Testando conexão...", null);
      const pub = await getPublic();
      if (!pub?.ok) throw new Error("Resposta inválida");
      setStatus($("statusTopo"), "✅ Conexão OK.", true);
    }catch(e){
      setStatus($("statusTopo"), "❌ Falha ao testar. Reimplante o Web App se necessário.", false);
    }
  };

  // Carregar cardápio atual
  $("btnCarregarCardapio").onclick = async () => {
    try{
      setStatus($("statusCardapio"), "Carregando...", null);
      const pub = await getPublic();
      $("cardapioImg").value = (pub.cardapio?.img || "");
      $("cardapioTexto").value = (pub.cardapio?.texto || "");
      setPreview(pub.cardapio?.img || "");
      setStatus($("statusCardapio"), "✅ Cardápio carregado.", true);
    }catch(e){
      setStatus($("statusCardapio"), "❌ Não foi possível carregar.", false);
    }
  };

  // Salvar usando URL manual
  $("btnSalvarCardapio").onclick = async () => {
    try{
      setStatus($("statusCardapio"), "Salvando...", null);
      const res = await postAdmin({
        action: "update_menu",
        cardapio_img: $("cardapioImg").value.trim(),
        cardapio_texto: $("cardapioTexto").value.trim()
      });
      if (!res?.ok) throw new Error(res?.error || "Erro ao salvar");
      setPreview($("cardapioImg").value);
      setStatus($("statusCardapio"), "✅ Cardápio atualizado!", true);
    }catch(e){
      setStatus($("statusCardapio"), "❌ " + (e.message || "Erro"), false);
    }
  };

  // ✅ Upload imagem do PC -> Drive -> salva URL no Config
  $("btnEnviarImagem").onclick = async () => {
    const f = $("cardapioFile").files[0];
    if (!f) return alert("Selecione uma imagem primeiro.");

    const MAX_MB = 5;
    if (f.size > MAX_MB * 1024 * 1024) {
      return alert(`Arquivo muito grande. Máximo: ${MAX_MB}MB`);
    }

    try{
      setStatus($("statusUpload"), "Enviando imagem...", null);

      // lê como base64
      const base64 = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(f);
      });

      // 1) upload no Drive via API
      const up = await postAdmin({
        action: "upload_menu_image",
        base64,
        mime: f.type || "image/jpeg",
        filename: f.name || "cardapio.jpg"
      });
      if (!up?.ok) throw new Error(up?.error || "Falha no upload");

      // 2) preenche URL
      $("cardapioImg").value = up.image_url;
      setPreview(up.image_url);

      // 3) salva no Config
      const res = await postAdmin({
        action: "update_menu",
        cardapio_img: up.image_url,
        cardapio_texto: $("cardapioTexto").value.trim()
      });
      if (!res?.ok) throw new Error(res?.error || "Falha ao salvar no Config");

      setStatus($("statusUpload"), "✅ Imagem enviada e cardápio atualizado!", true);
      setStatus($("statusCardapio"), "✅ Cardápio atualizado!", true);
    }catch(e){
      setStatus($("statusUpload"), "❌ " + (e.message || "Erro"), false);
    }
  };

  // Dashboard
  function renderChips(container, obj){
    container.innerHTML = "";
    const keys = Object.keys(obj || {});
    if (!keys.length) return;
    keys.forEach(k => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = `${k}: ${obj[k]}`;
      container.appendChild(chip);
    });
  }

  $("btnDash").onclick = async () => {
    try{
      setStatus($("statusDash"), "Atualizando dashboard...", null);
      const res = await postAdmin({ action: "dashboard" });
      if (!res?.ok) throw new Error(res?.error || "Erro");

      const d = res.dashboard || {};
      $("kpis").innerHTML = `
        <div class="kpi"><b>Total de pedidos</b>${d.totalPedidos ?? 0}</div>
        <div class="kpi"><b>Pedidos hoje</b>${d.pedidosHoje ?? 0}</div>
      `;
      renderChips($("chipsPg"), d.porPagamento);
      renderChips($("chipsOrigem"), d.porOrigem);

      setStatus($("statusDash"), "✅ Dashboard atualizado.", true);
    }catch(e){
      setStatus($("statusDash"), "❌ " + (e.message || "Erro"), false);
    }
  };

  // Pedidos
  let lastOrders = [];

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function renderTable(data){
    const headers = ["DataHora","Nome","Telefone","Endereco","Pedido","Pagamento","Troco","Obs","Origem"];
    $("tbl").querySelector("thead").innerHTML =
      "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
    $("tbl").querySelector("tbody").innerHTML =
      data.map(o => `<tr>${headers.map(h => `<td>${escapeHtml(o[h])}</td>`).join("")}</tr>`).join("");
  }

  $("btnPedidos").onclick = async () => {
    try{
      setStatus($("statusPedidos"), "Carregando pedidos...", null);
      const res = await postAdmin({ action: "list_orders" });
      if (!res?.ok) throw new Error(res?.error || "Erro");
      lastOrders = res.data || [];
      renderTable(lastOrders);
      $("btnExportar").disabled = !lastOrders.length;
      setStatus($("statusPedidos"), `✅ ${lastOrders.length} pedidos carregados.`, true);
    }catch(e){
      setStatus($("statusPedidos"), "❌ " + (e.message || "Erro"), false);
      $("btnExportar").disabled = true;
    }
  };

  $("btnExportar").onclick = () => {
    if (!lastOrders.length) return;
    const headers = ["DataHora","Nome","Telefone","Endereco","Pedido","Pagamento","Troco","Obs","Origem"];
    const csv = [
      headers.join(";"),
      ...lastOrders.map(o => headers.map(h => `"${(o[h] ?? "").toString().replaceAll('"','""')}"`).join(";"))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pedidos.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  // Carrega o cardápio atual ao abrir
  (async () => {
    try {
      const pub = await getPublic();
      if (pub?.ok) {
        $("cardapioImg").value = pub.cardapio?.img || "";
        $("cardapioTexto").value = pub.cardapio?.texto || "";
        setPreview(pub.cardapio?.img || "");
      }
    } catch(e) {}
  })();
</script>
</body>
</html>
